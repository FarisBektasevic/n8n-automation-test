<!doctype html>
<html lang="sr">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />

    <!-- Prevent aggressive caching -->
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>n8n Automatizacije v1.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        overscroll-behavior: none;
        -webkit-tap-highlight-color: transparent;
      }
      .shine-effect {
        position: absolute;
        inset: 0;
        background: linear-gradient(
          to right,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transform: translateX(-100%);
        transition: transform 1s;
      }
      button:active .shine-effect {
        transform: translateX(100%);
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .animate-spin {
        animation: spin 1s linear infinite;
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white"
  >
    <div id="app" class="min-h-screen p-4 pb-8"></div>

    <script>
      // Simple state management
      // KAKO DODATI VIŠE AUTOMATIZACIJA:
      // 1. Otvori ovaj fajl u text editoru
      // 2. Pronađi niz 'automations' ispod
      // 3. Dodaj novi objekat sa jedinstvenim id, name, url='', i color
      // 4. Dostupne boje: 'from-purple-500 to-pink-500', 'from-blue-500 to-cyan-500',
      //    'from-orange-500 to-red-500', 'from-green-500 to-emerald-500',
      //    'from-yellow-500 to-amber-500', 'from-indigo-500 to-purple-500',
      //    'from-rose-500 to-pink-500', 'from-teal-500 to-cyan-500'

      let state = {
        automations: JSON.parse(
          localStorage.getItem('n8n_automations') ||
            JSON.stringify([
              {
                id: 1,
                name: 'Bosna',
                url: 'https://bektas.app.n8n.cloud/webhook/8f0ce6d6-66e3-4c4a-b176-e5321b84c206',
                color: 'from-green-500 to-emerald-500',
              },
              {
                id: 2,
                name: 'Crna Gora',
                url: 'https://bektas.app.n8n.cloud/webhook/0df5102e-6806-4339-a4ce-b9365c2e6a08',
                color: 'from-blue-500 to-cyan-500',
              },
            ]),
        ),
        triggering: null,
        feedback: null,
        cooldowns: {}, // Track last trigger time for each automation
      };

      const COOLDOWN_SECONDS = 30; // Prevent triggering again for 3 seconds

      let countdownInterval = null;

      function startCountdownTimer() {
        // Clear any existing interval
        if (countdownInterval) {
          clearInterval(countdownInterval);
        }

        // Update countdown every second
        countdownInterval = setInterval(() => {
          // Check if any automation is still in cooldown
          const hasActiveCooldown = state.automations.some(a =>
            isInCooldown(a.id),
          );

          if (hasActiveCooldown) {
            render(); // Update display
          } else {
            clearInterval(countdownInterval); // Stop timer when no cooldowns active
            countdownInterval = null;
          }
        }, 1000);
      }

      function isInCooldown(id) {
        const now = Date.now();
        const lastTrigger = state.cooldowns[id] || 0;
        const timeSinceLastTrigger = (now - lastTrigger) / 1000;
        return timeSinceLastTrigger < COOLDOWN_SECONDS;
      }

      function getRemainingCooldown(id) {
        const now = Date.now();
        const lastTrigger = state.cooldowns[id] || 0;
        const timeSinceLastTrigger = (now - lastTrigger) / 1000;
        return Math.ceil(COOLDOWN_SECONDS - timeSinceLastTrigger);
      }

      const colors = [
        'from-purple-500 to-pink-500',
        'from-blue-500 to-cyan-500',
        'from-orange-500 to-red-500',
        'from-green-500 to-emerald-500',
        'from-yellow-500 to-amber-500',
        'from-indigo-500 to-purple-500',
        'from-rose-500 to-pink-500',
        'from-teal-500 to-cyan-500',
      ];

      function render() {
        const app = document.getElementById('app');
        app.innerHTML = `
                <!-- Header -->
                <div class="max-w-md mx-auto pt-8 pb-6">
                    <div class="flex items-start justify-start mb-2">
                        <div class="flex items-start gap-3">
                            <div class="bg-gradient-to-br from-yellow-400 to-orange-500 p-3 rounded-2xl shadow-lg shadow-orange-500/50">
                                <svg class="w-8 h-8 text-slate-900" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                            </div>
                            <div>
                                <h1 class="text-3xl font-black tracking-tight">Taman AI</h1>
                                <p class="text-sm text-purple-300 font-medium">Prijavljivanje paketa</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Automation Buttons -->
                <div class="max-w-md mx-auto space-y-3">
                    ${state.automations
                      .map(
                        (automation, index) => `
                        <div class="relative" style="animation-delay: ${index * 50}ms">
                            <button
                                onclick="triggerAutomation(${automation.id})"
                                ${state.triggering === automation.id || isInCooldown(automation.id) ? 'disabled' : ''}
                                class="w-full bg-gradient-to-r ${automation.color} rounded-2xl p-6 shadow-xl hover:shadow-2xl transform hover:scale-105 active:scale-95 transition-all duration-200 relative overflow-hidden group disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
                            >
                                    <div class="shine-effect"></div>
                                    
                                    <div class="relative flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="bg-white/20 backdrop-blur-sm p-2 rounded-lg">
                                                ${
                                                  state.triggering ===
                                                  automation.id
                                                    ? `
                                                    <div class="w-6 h-6 border-3 border-white border-t-transparent rounded-full animate-spin"></div>
                                                `
                                                    : state.feedback?.id ===
                                                        automation.id
                                                      ? state.feedback.type ===
                                                        'success'
                                                        ? `
                                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3">
                                                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                                        </svg>
                                                    `
                                                        : `
                                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3">
                                                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                                        </svg>
                                                    `
                                                      : `
                                                    <svg class="w-6 h-6 fill-white" viewBox="0 0 24 24">
                                                        <path d="M8 5v14l11-7z"/>
                                                    </svg>
                                                `
                                                }
                                            </div>
                                            <div class="text-left">
                                                <div class="text-lg font-bold tracking-tight">${automation.name}</div>
                                                ${
                                                  state.feedback?.id ===
                                                  automation.id
                                                    ? `
                                                    <div class="text-sm text-white/90 font-medium">${state.feedback.message}</div>
                                                    ${state.feedback.detail ? `<div class="text-xs text-white/70 mt-0.5">${state.feedback.detail}</div>` : ''}
                                                `
                                                    : isInCooldown(
                                                          automation.id,
                                                        ) &&
                                                        state.triggering !==
                                                          automation.id
                                                      ? `
                                                    <div class="text-sm text-white/80 font-medium">Čekaj ${getRemainingCooldown(automation.id)}s...</div>
                                                `
                                                      : ''
                                                }
                                            </div>
                                        </div>
                                        <svg class="w-8 h-8 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                    </div>
                                </button>
                                ${
                                  isInCooldown(automation.id) &&
                                  state.triggering !== automation.id
                                    ? `
                                    <div class="absolute bottom-0 left-0 right-0 h-1 bg-white/20 rounded-b-2xl overflow-hidden">
                                        <div class="h-full bg-white/60 transition-all duration-1000 ease-linear" 
                                             style="width: ${(getRemainingCooldown(automation.id) / COOLDOWN_SECONDS) * 100}%">
                                        </div>
                                    </div>
                                `
                                    : ''
                                }
                        </div>
                    `,
                      )
                      .join('')}
                </div>

                <!-- Version indicator -->
                <div class="max-w-md mx-auto mt-8 text-center text-white/40 text-xs pb-4">
                    Taman AI v1.0 • Last updated: Feb 2026
                </div>
            `;
      }

      async function triggerAutomation(id) {
        const automation = state.automations.find(a => a.id === id);

        if (!automation.url) {
          state.feedback = {
            type: 'error',
            id,
            message: 'URL nije postavljen',
            detail: '',
          };
          render();
          setTimeout(() => {
            state.feedback = null;
            render();
          }, 3000);
          return;
        }

        // Check cooldown
        const now = Date.now();
        const lastTrigger = state.cooldowns[id] || 0;
        const timeSinceLastTrigger = (now - lastTrigger) / 1000;

        if (timeSinceLastTrigger < COOLDOWN_SECONDS) {
          const remainingTime = Math.ceil(
            COOLDOWN_SECONDS - timeSinceLastTrigger,
          );
          state.feedback = {
            type: 'error',
            id,
            message: `Čekaj ${remainingTime}s`,
            detail: 'Sprečava dvostruko pokretanje',
          };
          render();
          setTimeout(() => {
            state.feedback = null;
            render();
          }, 2000);
          return;
        }

        // Set cooldown and schedule automatic unlock
        state.cooldowns[id] = now;
        state.triggering = id;
        render();

        // Start countdown timer to update remaining time every second
        startCountdownTimer();

        // Schedule automatic button unlock after cooldown expires
        setTimeout(() => {
          render(); // Re-render to enable button after cooldown
        }, COOLDOWN_SECONDS * 1000);

        try {
          // Dodaj query parametre u URL
          const url = new URL(automation.url);
          url.searchParams.append('triggered_at', new Date().toISOString());
          url.searchParams.append('source', 'mobile_app');

          console.log('Šaljem GET zahtev ka:', url.toString());

          const response = await fetch(url.toString(), {
            method: 'GET',
          });

          console.log('Status:', response.status);

          if (response.ok) {
            state.feedback = {
              type: 'success',
              id,
              message: '✓ Aktivirano!',
              detail: '',
            };
          } else {
            state.feedback = {
              type: 'error',
              id,
              message: `HTTP ${response.status}`,
              detail:
                response.status === 404
                  ? 'Webhook ne postoji'
                  : response.status === 401
                    ? 'Neautorizovan'
                    : response.status === 500
                      ? 'n8n server greška'
                      : 'Proveri workflow',
            };
          }
        } catch (error) {
          console.error('Greška:', error);

          let errorMsg = 'Greška';
          let detail = '';

          if (error.message.includes('Failed to fetch')) {
            errorMsg = 'CORS problem';
            detail = 'Proveri n8n webhook podešavanja';
          } else if (error.message.includes('NetworkError')) {
            errorMsg = 'Nema interneta';
            detail = 'Proveri konekciju';
          } else {
            errorMsg = 'Greška';
            detail = error.message.substring(0, 30);
          }

          state.feedback = { type: 'error', id, message: errorMsg, detail };
        }

        state.triggering = null;
        render();

        setTimeout(() => {
          state.feedback = null;
          render();
        }, 4000);
      }

      // Initial render
      render();
    </script>
  </body>
</html>
